{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 6{% endblock %}

{% block script %}
<script>
const CURRENT_LOGIN = '{{ current_login }}'; 

function getOfficeList () {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc': '2.0',
        'method': 'info',
        'id': Math.round(Math.random()*1000)
    };
    fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        const office_list = data.result;
        const ul = document.getElementById('office-list');
        ul.innerHTML = '';
        for(let i= 0; i < office_list.length; i++) {
            const office = office_list[i];
            const li= document.createElement('li');
            li.innerText=`${office.number}: ${office.tenant || '–°–≤–æ–±–æ–¥–µ–Ω'}`;

            const isBooked = office.tenant !== '';
            const isMyBooking = office.tenant === CURRENT_LOGIN;

            if (isMyBooking) {
                const cancelButton = document.createElement('button');
                cancelButton.innerText = '–û—Å–≤–æ–±–æ–¥–∏—Ç—å üîì';
                cancelButton.onclick = function() {cancellation(office.number)};
                li.appendChild(cancelButton);
            } else if (!isBooked && CURRENT_LOGIN) {
                const bookingButton = document.createElement('button');
                bookingButton.innerText = '–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å üìù';
                bookingButton.onclick = function() {booking(office.number)};
                li.appendChild(bookingButton);
            }

            ul.appendChild(li);
        }
    });
}

function cancellation(officeNumber) {
    callApi('cancellation', officeNumber);
}

function booking(officeNumber) {
    callApi('booking', officeNumber);
}

function callApi(methodName, officeNumber) {
    const url = '/lab6/json-rpc-api/';
    const json = {
        'jsonrpc':'2.0',
        'method': methodName,
        'params': officeNumber,
        'id': Math.round(Math.random()*1000)
    };
    fetch(url, {
        method:'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json()
    })
    .then(function(data) {
        if(data.error) {
            handleError(data.error);
        }
        else {
            document.getElementById('office-list').innerHTML =''; 
            getOfficeList();
        }
    });
}

function handleError(error) {
    let message = '';
    switch(error.code) {
        case 1:
            message = '–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å (Unauthorized).';
            break;
        case 2:
            message = '–û—Ñ–∏—Å —É–∂–µ –∞—Ä–µ–Ω–¥—É–µ—Ç—Å—è (Already booked).';
            break;
        case 3:
            message = '–û—Ñ–∏—Å –Ω–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω, –µ–≥–æ –Ω–µ–ª—å–∑—è –æ—Å–≤–æ–±–æ–¥–∏—Ç—å (Not booked).';
            break;
        case 4:
            message = '–≠—Ç–æ—Ç –æ—Ñ–∏—Å –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –µ–≥–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å (Not your booking).';
            break;
        case -32601:
            message = '–°—Ç—Ä–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: –ú–µ—Ç–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            break;
        case -32602:
            message = '–û—à–∏–±–∫–∞ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö: –û—Ñ–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.';
            break;
        default:
            message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ' + error.message;
            break;
    }
    alert(message);
}

document.addEventListener('DOMContentLoaded', function() {
    getOfficeList();
});
</script>
{% endblock %}

{% block main %}
    <h1>–°–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–í–∞—à –ª–æ–≥–∏–Ω: {{ current_login or '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' }})</h1>
    <a href="{{index_url}}">–ù–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
    <ul id="office-list"></ul>
{% endblock %}