{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div class="ny-container">
    <h1 style="color: #2e7d32;">üéÑ –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º! üéÅ</h1>
    <p>–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ –±–æ–ª–µ–µ 3 –∫–æ—Ä–æ–±–æ–∫ —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏.</p>
    <div id="remaining-info">
        –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–¥ –µ–ª–∫–æ–π: <strong id="unopened-count">{{ remaining }}</strong>
    </div>
    <div class="gift-grid">
        {% for opened in opened_boxes %}
        <div class="gift-box" id="box-{{ loop.index0 }}" onclick="tryOpenBox({{ loop.index0 }})">
            {% if opened %}
                <div class="empty-box">–ü—É—Å—Ç–æ ‚ùÑÔ∏è</div>
            {% else %}
                {% if loop.index in [6, 7, 10] %}
                    <img src="{{ url_for('static', filename='lab9/box_closed_' ~ loop.index ~ '.webp') }}" alt="–ü–æ–¥–∞—Ä–æ–∫">
                {% else %}
                    <img src="{{ url_for('static', filename='lab9/box_closed_' ~ loop.index ~ '.jpg') }}" alt="–ü–æ–¥–∞—Ä–æ–∫">
                {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
    <div id="present-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="congrats-text"></h2>
            <div class="img-wrapper">
                <img id="present-img" src="" alt="–í–∞—à –ø–æ–¥–∞—Ä–æ–∫">
            </div>
            <button class="ny-btn" onclick="closeModal()">–£—Ä–∞!</button>
        </div>
    </div>
</div>
<style>
    .ny-container { 
        text-align: center; 
        background: #faffff; 
        padding: 20px; 
        border-radius: 20px; 
        border: 5px dashed #c41e3a; 
    }
    #remaining-info { margin-bottom: 20px; font-size: 1.5em; color: #2e7d32; }
    .gift-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        max-width: 900px;
        margin: 20px auto;
    }
    .gift-box {
        border: 2px solid #ffd700;
        border-radius: 10px;
        cursor: pointer;
        transition: transform 0.2s;
        background: white;
        height: 126px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        overflow: hidden;
    }
    .gift-box:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(196, 30, 58, 0.3); }
    .gift-box img { 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain;
    }
    .empty-box { color: #ccc; font-style: italic; font-size: 1.1em; }
    .img-wrapper {
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
    }
    .img-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 25px; border-radius: 15px; border: 4px solid #c41e3a; width: 90%; max-width: 450px; text-align: center; }
    .img-wrapper {
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
    }
    .ny-btn {
        background: #c41e3a;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
    }
</style>

<script>
function tryOpenBox(id) {
    const boxElement = document.getElementById(`box-${id}`);
    if (boxElement.querySelector('.empty-box')) return;

    fetch('/lab9/open_box', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error) });
        }
        return response.json();
    })
    .then(data => {
        boxElement.innerHTML = '<div class="empty-box">–ü—É—Å—Ç–æ ‚ùÑÔ∏è</div>';
        document.getElementById('unopened-count').innerText = data.remaining;
        
        document.getElementById('congrats-text').innerText = data.present.text;
        document.getElementById('present-img').src = '/static/' + data.present.img;
        document.getElementById('present-modal').style.display = 'flex';
    })
    .catch(error => {
        alert(error.message);
    });
}
function closeModal() {
    document.getElementById('present-modal').style.display = 'none';
}
</script>
{% endblock %}