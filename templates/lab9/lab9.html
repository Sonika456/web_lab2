{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
<div class="ny-container">
    <h1 style="color: #c41e3a;">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏ üéÅ</h1>
    
    {% if current_user.is_authenticated %}
        <div style="margin-bottom: 20px;">
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <b>{{ current_user.login }}</b>!</p>
            <button class="santa-btn" onclick="resetAllBoxes()">üéÖ –ü–æ–∑–≤–∞—Ç—å –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ (–°–±—Ä–æ—Å)</button>
            <a href="/lab8/logout" style="margin-left: 10px; color: #c41e3a;">–í—ã–π—Ç–∏</a>
        </div>
    {% else %}
        <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ffd700; border-radius: 10px; background: #fffde7;">
            <p>–•–æ—Ç–∏—Ç–µ VIP-–ø–æ–¥–∞—Ä–∫–∏? üéÅ</p>
            <a href="/lab8/login" class="ny-btn" style="text-decoration: none; display: inline-block;">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>
        </div>
    {% endif %}

    <div id="remaining-info">
        –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–¥–∞—Ä–∫–æ–≤: <strong id="unopened-count">{{ remaining }}</strong>
    </div>

    <div class="gift-grid">
        {% for opened in opened_boxes %}
        <div class="gift-box" id="box-{{ loop.index0 }}" onclick="tryOpenBox({{ loop.index0 }})">
            {% if opened %}
                <div class="empty-box">–ü—É—Å—Ç–æ ‚ùÑÔ∏è</div>
            {% else %}
                {% if loop.index in [6, 7, 10] %}
                    <img src="{{ url_for('static', filename='lab9/box_closed_' ~ loop.index ~ '.webp') }}" alt="Box">
                {% else %}
                    <img src="{{ url_for('static', filename='lab9/box_closed_' ~ loop.index ~ '.jpg') }}" alt="Box">
                {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div id="present-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="congrats-text"></h2>
            <div class="img-wrapper"><img id="present-img" src=""></div>
            <button class="ny-btn" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>
<style>
    .ny-container { 
        text-align: center; 
        background: #faffff; 
        padding: 20px; 
        border-radius: 20px; 
        border: 5px dashed #c41e3a; 
    }
    #remaining-info { 
        margin-bottom: 20px; 
        font-size: 1.5em; 
        color: #2e7d32; 
    }
    .gift-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        max-width: 900px;
        margin: 20px auto;
        }  
    .santa-btn {
        background: #2e7d32;
        color: white;
        border: 3px solid #ffd700;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        transition: 0.3s;
    }
    .santa-btn:hover { 
        background: #1b5e20; 
        transform: translateY(-3px); 
    }
    .gift-box { 
        border: 2px solid #ffd700; 
        background: white; 
        height: 126px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        overflow: hidden;
    }
    .gift-box:hover { 
        transform: scale(1.05); 
        box-shadow: 0 0 15px rgba(196, 30, 58, 0.3); 
    }
    .gift-box img { 
        max-width: 100%; 
        max-height: 100%; 
        object-fit: contain;
    }
    .empty-box { 
        color: #ccc; 
        font-style: italic; 
        font-size: 1.1em; 
    }
    .img-wrapper {
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
    }
    .img-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .modal { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.8); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
    }
    .modal-content { 
        background: white; 
        padding: 25px; 
        border-radius: 15px; 
        border: 4px solid #c41e3a; 
        width: 90%; 
        max-width: 450px; 
        text-align: center; 
    }
    .img-wrapper {
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
    }
    .ny-btn {
        background: #c41e3a;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.1em;
    }
</style>

<script>
function tryOpenBox(id) {
    const boxElement = document.getElementById(`box-${id}`);
    if (boxElement.querySelector('.empty-box')) return;

    fetch('/lab9/open_box', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error) });
        }
        return response.json();
    })
    .then(data => {
        boxElement.innerHTML = '<div class="empty-box">–ü—É—Å—Ç–æ ‚ùÑÔ∏è</div>';
        document.getElementById('unopened-count').innerText = data.remaining;
        document.getElementById('congrats-text').innerText = data.present.text;
        document.getElementById('present-img').src = '/static/' + data.present.img;
        document.getElementById('present-modal').style.display = 'flex';
    })
    .catch(error => alert(error.message));
}
function resetAllBoxes() {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞ –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏?")) return;
    fetch('/lab9/reset', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
function closeModal() { 
    document.getElementById('present-modal').style.display = 'none'; 
}
</script>
{% endblock %}